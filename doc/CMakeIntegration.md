<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /doc/mdsource/CMakeIntegration.source.md
To change this file edit the source file and then execute ./run_markdown_templates.sh.
-->

<a id="top"></a>

# CMake Integration

<!-- toc -->
## Contents

  * [Introduction](#introduction)
  * [CMake target](#cmake-target)
  * [CMake project options](#cmake-project-options)
  * [Scenarios when using ApprovalTests.cpp](#scenarios-when-using-approvaltestscpp)
    * [Context](#context)
    * [Make CMake clone ApprovalTests.cpp](#make-cmake-clone-approvaltestscpp)
    * [Make CMake clone ApprovalTests.cpp and Catch2](#make-cmake-clone-approvaltestscpp-and-catch2)
    * [Use own ApprovalTests.cpp and Catch2 clones](#use-own-approvaltestscpp-and-catch2-clones)
    * [Using other supported test frameworks](#using-other-supported-test-frameworks)
  * [Scenarios when developing ApprovalTests.cpp](#scenarios-when-developing-approvaltestscpp)
    * [Developing ApprovalTests.cpp with test framework sources](#developing-approvaltestscpp-with-test-framework-sources)<!-- endtoc -->

## Introduction

Because we use CMake to build Catch2, we also provide integration points for our users.

## CMake target

Approval Tests' CMake build exports an interface target `ApprovalTests::ApprovalTests`. Linking
against it will add the proper include path and all necessary capabilities
to the resulting binary.

This target is provided when ApprovalTests.cpp is used as a subdirectory.
Assuming that ApprovalTests.cpp has been cloned to `lib/ApprovalTests.cpp`:

```cmake
add_subdirectory(lib/ApprovalTests.cpp)
target_link_libraries(tests ApprovalTests::ApprovalTests)
```

## CMake project options

ApprovalTests.cpp's CMake project also provides some options for other projects
that consume it. These are:

* `APPROVAL_TESTS_ENABLE_CODE_COVERAGE` -- When `ON`, Approval Test's own tests are run with code coverage enabled. This uses [Lars Bilke's CodeCoverage.cmake](https://github.com/bilke/cmake-modules/blob/master/CodeCoverage.cmake).  Defaults to `OFF`.

Options that only affect the main project, and have no effect if `add_subdirectory()` or similar is used:

* `APPROVAL_TESTS_BUILD_CMAKE_INTEGRATION_TESTING` -- When `ON`, the tests in [tests/CMake_Tests](https://github.com/approvals/ApprovalTests.cpp/blob/master/tests/CMake_Tests) are run. Their job is to check that our CMake integrations still work. Note that these tests always run if this is the top-level project. Otherwise, they are only run if this is on and `APPROVAL_TESTS_BUILD_TESTING` is also on. Defaults to `OFF`.

Currently, these are all the supported options:

<!-- snippet: ApprovalTestsOptions.cmake -->
<a id='snippet-ApprovalTestsOptions.cmake'/></a>
```cmake
# TODO Move this to the end
option(APPROVAL_TESTS_ENABLE_CODE_COVERAGE "Enable coverage reporting for selected tests" OFF)

# TODO Remove this
option(APPROVAL_TESTS_BUILD_CMAKE_INTEGRATION_TESTING "Enable tests that check our CMake integration" OFF)

# Control which of our copies of third_party libraries are made available
# TODO Add APPROVAL_TESTS_BUILD_THIRD_PARTY_ALL
option(APPROVAL_TESTS_BUILD_THIRD_PARTY_CATCH2
        "Include this project's copy of the Catch2 test framework"
        OFF)
option(APPROVAL_TESTS_BUILD_THIRD_PARTY_DOCTEST
        "Include this project's copy of the doctest test framework"
        OFF)
option(APPROVAL_TESTS_BUILD_THIRD_PARTY_UT
        "Include this project's copy of the Boost.UT test framework"
        OFF)

# Control of what targets are built
# TODO Add APPROVAL_TESTS_BUILD_ALL
option(APPROVAL_TESTS_BUILD_TESTING
        "Build self-tests. Note that these are always built if this is the top-level project"
        OFF)
option(APPROVAL_TESTS_BUILD_EXAMPLES
        "Build documentation examples. Note that these are always built if this is the top-level project"
        OFF)
```
<sup><a href='/CMake/ApprovalTestsOptions.cmake#L1-L26' title='File snippet `ApprovalTestsOptions.cmake` was extracted from'>snippet source</a> | <a href='#snippet-ApprovalTestsOptions.cmake' title='Navigate to start of snippet `ApprovalTestsOptions.cmake`'>anchor</a></sup>
<!-- endsnippet -->

## Scenarios when using ApprovalTests.cpp 

### Context

Suppose you are writing some tests that use ApprovalTests.cpp with the Catch2 test framework.

Your CMakeLists.txt file might look something like this:

 <!-- include: inc_fetch_content_approvaltests_tests_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_tests_cmakelists.include.md -->

```cmake
add_executable(tests
        main.cpp
        tests.cpp
)
target_link_libraries(tests ApprovalTests::ApprovalTests Catch2::Catch2)

target_compile_features(tests PUBLIC cxx_std_11)
set_target_properties(tests PROPERTIES CXX_EXTENSIONS OFF)

add_test(
        NAME tests
        COMMAND tests)
```
 <!-- end include: inc_fetch_content_approvaltests_tests_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_tests_cmakelists.include.md -->

This says that the libraries `ApprovalTests::ApprovalTests` and `Catch2::Catch2` are required.

How might you enable CMake to provide those libraries?

### Make CMake clone ApprovalTests.cpp

The following is for when you just want ApprovalTests.cpp to be downloaded as part of your project's build. You don't particularly want to see its source code, although you're happy if your debugger steps in to its source code.

It also needs CMake 3.14 or above.

This might be your project's top level CMake file:

 <!-- include: inc_fetch_content_approvaltests_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_cmakelists.include.md -->

```cmake
cmake_minimum_required(VERSION 3.14 FATAL_ERROR)
# This version is needed for FetchContent_Declare & FetchContent_MakeAvailable

project(fetch_content_approvaltests)

enable_testing()

add_subdirectory(dependencies)
add_subdirectory(tests)
```
 <!-- end include: inc_fetch_content_approvaltests_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_cmakelists.include.md -->

The important thing to note is the `add_subdirectory(dependencies)` line.

It will use the file: `dependencies/CMakeLists.txt`:

 <!-- include: inc_fetch_content_approvaltests_dependencies_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_dependencies_cmakelists.include.md -->

```cmake
# Needs CMake 3.14 or above
include(FetchContent)

# -------------------------------------------------------------------
# ApprovalTests.cpp
FetchContent_Declare(ApprovalTests
        GIT_REPOSITORY https://github.com/approvals/ApprovalTests.cpp.git
        GIT_TAG cmake_docs) # TODO Merge cmake_docs to default - then change this to master

# Tell the ApprovalTests CMake files that we want to use its copy of Catch2:
set(APPROVAL_TESTS_BUILD_THIRD_PARTY_CATCH2 ON CACHE BOOL "")

FetchContent_MakeAvailable(ApprovalTests)
```
 <!-- end include: inc_fetch_content_approvaltests_dependencies_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_dependencies_cmakelists.include.md -->

There are also options to enable use of ApprovalTests.cpp's copies of all other supported test frameworks except GoogleTest, including:

* `APPROVAL_TESTS_BUILD_THIRD_PARTY_DOCTEST`
* `APPROVAL_TESTS_BUILD_THIRD_PARTY_UT`

Note the `GIT_TAG` value: CMake needs to know which revision to use.

Note also that here we are using the copy of Catch2 that is included in the ApprovalTests.cpp repository.

### Make CMake clone ApprovalTests.cpp and Catch2

The only difference between the previous example and this one is that we get CMake to also download and use the Catch2 repository. 

We use this file: `dependencies/CMakeLists.txt`:

 <!-- include: inc_fetch_content_approvaltests_catch2_dependencies_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_catch2_dependencies_cmakelists.include.md -->

```cmake
# Needs CMake 3.14 or above
include(FetchContent)

# -------------------------------------------------------------------
# ApprovalTests.cpp
FetchContent_Declare(ApprovalTests
        GIT_REPOSITORY https://github.com/approvals/ApprovalTests.cpp.git
        GIT_TAG cmake_docs) # TODO Merge cmake_docs to default - then change this to master

FetchContent_MakeAvailable(ApprovalTests)

# -------------------------------------------------------------------
# Catch2
FetchContent_Declare(Catch2
        GIT_REPOSITORY https://github.com/catchorg/Catch2.git
        GIT_TAG v2.11.1)

FetchContent_MakeAvailable(Catch2)
```
 <!-- end include: inc_fetch_content_approvaltests_catch2_dependencies_cmakelists. path: /doc/mdsource/inc_fetch_content_approvaltests_catch2_dependencies_cmakelists.include.md -->

### Use own ApprovalTests.cpp and Catch2 clones

Here, instead of getting CMake to download ApprovalTests.cpp and Catch2, we have got our own clones or forks of them, which we want to use with our own tests.

This works with older versions of CMake, unlike the `FetchContent` examples above. The following `dependencies/CMakeLists.txt` file was tested with CMake 3.8.

 <!-- include: inc_add_subdirectory_approvaltests_catch2_dependencies_cmakelists. path: /doc/mdsource/inc_add_subdirectory_approvaltests_catch2_dependencies_cmakelists.include.md -->

```cmake
# -------------------------------------------------------------------
# ApprovalTests.cpp
add_subdirectory(
        ../../ApprovalTests.cpp
        ${CMAKE_CURRENT_BINARY_DIR}/approvaltests.cpp_build
)

# -------------------------------------------------------------------
# Catch2
set(CATCH_BUILD_TESTING OFF CACHE BOOL "")
add_subdirectory(
        ../../Catch2
        ${CMAKE_CURRENT_BINARY_DIR}/catch2_build
)
```
 <!-- end include: inc_add_subdirectory_approvaltests_catch2_dependencies_cmakelists. path: /doc/mdsource/inc_add_subdirectory_approvaltests_catch2_dependencies_cmakelists.include.md -->

### Using other supported test frameworks

To save space and repetition, the examples above only show the Catch2 framework.

The same principles apply when using all the other test frameworks supported by ApprovalTests.cpp.

## Scenarios when developing ApprovalTests.cpp 

### Developing ApprovalTests.cpp with test framework sources

It is useful to be able to edit and debug both this project and the test frameworks that it depends upon. It helps to be able to see the source code of these frameworks, rather than just the single-header releases that are copied in to the third_party directory here.

This also allows us to update to different commits of any of these projects.

Here we want to enable and run all the ApprovalTests.cpp tests, unlike the cases above, where we only want to run the tests of the project that is being developed by using this library.

If the repositories for all these projects are checked out in the the same directory, then this `CMakeLists.txt` file can be put in to a parallel directory.

 <!-- include: inc_develop_approvaltests_cmakelists. path: /doc/mdsource/inc_develop_approvaltests_cmakelists.include.md -->

```cmake
cmake_minimum_required(VERSION 3.8 FATAL_ERROR)

project(develop_approvaltests)

enable_testing()

# -------------------------------------------------------------------
# Catch2
set(CATCH_BUILD_TESTING OFF CACHE BOOL "")
add_subdirectory(
        ../Catch2
        ${CMAKE_CURRENT_BINARY_DIR}/catch2_build
)

# -------------------------------------------------------------------
# doctest
add_subdirectory(
        ../doctest
        ${CMAKE_CURRENT_BINARY_DIR}/doctest_build
)


# -------------------------------------------------------------------
# GoogleTest
# Prevent GoogleTest from overriding our compiler/linker options
# when building with Visual Studio
set(gtest_force_shared_crt ON CACHE BOOL "" )
add_subdirectory(
        ../googletest
        ${CMAKE_CURRENT_BINARY_DIR}/googletest_build
)

# -------------------------------------------------------------------
# Boost.ut
# ec49196855078d98738f54023b488b2f85299826 is the first commit that works with FetchContent
# TODO Add a Boost.UT issue asking for option names to have a prefix added
set(BUILD_BENCHMARKS OFF CACHE BOOL "")
set(BUILD_EXAMPLES OFF CACHE BOOL "")
set(BUILD_TESTS OFF CACHE BOOL "")

add_subdirectory(
        ../ut
        ${CMAKE_CURRENT_BINARY_DIR}/ut_build
)

if ("${CMAKE_CXX_COMPILER_ID}" MATCHES "Clang")
    # Turn off some checks for issues that should be fixed in ApprovalTests code
    target_compile_options(boost.ut INTERFACE
            -Wno-newline-eof
            -Wno-shadow-field-in-constructor
            -Wno-weak-vtables
            -Wno-c99-extensions # Needed for Boost.ut, at least in v1.1.6
            )
endif()

# -------------------------------------------------------------------
# ApprovalTests.cpp

set(APPROVAL_TESTS_BUILD_TESTING ON CACHE BOOL "")
set(APPROVAL_TESTS_BUILD_EXAMPLES ON CACHE BOOL "")
set(APPROVAL_TESTS_BUILD_CMAKE_INTEGRATION_TESTING ON CACHE BOOL "")

add_subdirectory(
        ../ApprovalTests.cpp
        ${CMAKE_CURRENT_BINARY_DIR}/approvaltests.cpp_build
)
```
 <!-- end include: inc_develop_approvaltests_cmakelists. path: /doc/mdsource/inc_develop_approvaltests_cmakelists.include.md -->

---

[Back to User Guide](/doc/README.md#top)
