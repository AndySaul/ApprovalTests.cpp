<a id="top"></a>

# Building Documentation

toc

## Introduction

The majority of the documentation in ApprovalTests.cpp is in Markdown format.

However, for a nicer user experience, that documentation is also published on Read the Docs, at 
[approvaltestscpp.readthedocs.io](https://approvaltestscpp.readthedocs.io/en/latest/).

The mechanism for that publishing is based on Sy Brand's [Clear, Functional C++ Documentation with Sphinx + Breathe + Doxygen + CMake](https://devblogs.microsoft.com/cppblog/clear-functional-c-documentation-with-sphinx-breathe-doxygen-cmake/).

## Required Tools

Tools:

* [mdsnippets](https://github.com/SimonCropp/MarkdownSnippets)
* [Doxygen](https://www.doxygen.nl/index.html)
* [Sphinx](https://www.sphinx-doc.org/en/master/)
* [pandoc](https://pandoc.org)
    * "pandoc is your swiss-army knife..." for converting between markup formats
* Python3

Python3 modules

* The required modules are defined in [doc/requirements.txt](/doc/requirements.txt)
    * That can be installed by running `build/install_python_requirements.sh`
* Currently, they are:
    * [breathe](https://breathe.readthedocs.io/en/latest/)
        * "Breathe provides a bridge between the Sphinx and Doxygen documentation systems."
    * [pypandoc](https://pypi.org/project/pypandoc/)
        * "Pypandoc provides a thin wrapper for pandoc, a universal document converter."
    * [sphinx_rtd_theme](https://sphinx-rtd-theme.readthedocs.io/en/latest/)
        * A sphinx theme, used primarily on [Read the Docs](http://www.readthedocs.org/)

## CMake Targets

On developer machines, where the required tools are installed, the following CMake targets are created: 

![CMake targets for building documentation](/doc/images/cmake_documentation_targets.png?raw=true)

## mdsnippets and Markdown Files

### mdsnippets Summary

* Purpose:
    * Update the machine-generated markdown files, which will be later used as inputs to the Sphinx documentation
* Output Files:
    * `doc/*.md`
    * `doc/explanations/*.md`
    * `doc/how_tos/.*md`

![Flow of Markdown files through mdsnippets](/doc/images/mdsnippets_flow.png?raw=true)

### mdsnippets Details

* Configuration files:
    * `doc/run_mdsnippets/CMakeLists.txt`
        * Creates a CMake target `RunMdsnippets`
            * Note: this is not included in the target `all`
        * This target makes it convenient to quickly run `run_markdown_templates.sh` from within CLion, without switching to a console window.
    * `mdsnippets.json`
        * Configuration used by mdsnippets
* Input files:
    * See [Maintaining Documentation](/doc/MaintainingDocumentation.md#top) for details.

## Images

* `doc/images/*`
    * Images for inclusion in docs
* `doc/images/tutorial/*`
    * Images for inclusion in docs
* `doc/images/source/*`
    * Sources for some of the images.
* `doc/images/source/generate_images.py`
    * Script that generates images from some source files.

## Doxygen Files

### Doxygen Summary

* Purpose:
    * Read the library's source code, to generate a set of XML files that describe the API
    * These XML files will later be read by Sphinx to create the API documentation
* Output Files:
    * `build_tree/doc/doxygen/xml/index.xml`
        * This and related .xml files are supplied to Sphinx, to generate the API docs on Read the Docs
    * `build_tree/doc/doxygen/html/index.html`
        * This file may be useful on developer machines, to review the documentation generated by Doxygen

![Flow of files through doxygen](/doc/images/doxygen_flow.png?raw=true)

### Doxygen Details

* Configuration files:
    * `doc/doxygen/CMakeLists.txt`
        * Creates a CMake target `Doxygen`
            * Note: this is not included in the target `all`
        * Manages the dependencies shown in the image above
    * `doc/doxygen/Doxyfile.in`
        * Template file containing the Doxygen configuration
        * CMake converts it to `Doxyfile` in the build tree
* Input files:
    * `doc/doxygen_doc/*.dox`
        * Files containing descriptive text for including in the Doxygen documentation
    * `doc/ApprovalTests/*.cpp`
    * `doc/ApprovalTests/*.h`

## Sphinx ReStructured Text Files

### Sphinx Summary

* Purpose:
    * Use the Sphinx system to generate a nicely formatted, usable version of our Markdown and C++ documentation, for serving from Read the Docs
* Output Files:
    * `build_tree/doc/sphinx/index.html`
    * [Read the Docs documentation](https://approvaltestscpp.readthedocs.io/en/latest/)

![Flow of files through Sphinx](/doc/images/sphinx_flow.png?raw=true)

### Sphinx Details

* Configuration files:
    * `doc/requirements.txt`
        * The Python requirements for running all Python scripts in `doc/`
        * Can be installed with pip3 by running `build/install_python_requirements.sh` 
    * `doc/sphinx/CMakeLists.txt`
        * Creates a CMake target `Sphinx`
            * Note: this is not included in the target `all`
        * Manages the dependencies shown in the image above
    * `doc/sphinx/_templates/breadcrumbs.html`
        * Prevents a broken "Edit on GitHub" from being added to each page on Read the Docs
        * This is because most of our Sphinx Documentation pages are machine-generated, so the "Edit on GitHub" would take users to a non-existent page
* Scripts:
    * `doc/sphinx/__init__.py`
    * `doc/sphinx/conf.py`
        * This contains our Sphinx configuration
        * It also runs the script markdown_conversion.py
        * It has some extra steps that are run only when generating the docs on Read the Docs (where CMake is not available)
    * `doc/sphinx/markdown_conversion.py`
        * Convert all the `*.md` files generated by mdsnippets to `*.rst` files for feeding in to Sphinx
        * For example, it changes some links so that they go to other pages in Sphinx
        * And other links it sends to the GitHub site
* Tests:
    * `doc/sphinx/tests/test_markdown_conversion.py`
        * Unit and Approval Tests for `doc/sphinx/tests/test_markdown_conversion.py`
    * `doc/sphinx/tests/test_markdown_conversion_input.md`
        * An input file with a range of different types of Markdown constructs, taken from our own documentation
* Input files:
    * `doc/sphinx/index.rst`
    * `doc/sphinx/api/*.rst`
    * Plus all the outputs from mdsnippets:
        * `doc/*.md`
        * `doc/explanations/*.md`
        * `doc/how_tos/*.md`
* Intermediate Files:
    * `doc/sphinx/generated_docs/*.rst`
    * `doc/sphinx/generated_docs/explanations/*.rst`
    * `doc/sphinx/generated_docs/how_tos/*.rst`
    * These are all ignored by git


---

[Back to User Guide](/doc/README.md#top)
